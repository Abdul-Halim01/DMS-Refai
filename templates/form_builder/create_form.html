{% extends 'base.html' %}

{% block title %}Create Form{% endblock %}

{% block content %}
<div class="form-container">
    <div class="styled-form">
        <div class="form-header">
            <h2>Create Dynamic Form</h2>
            <p class="form-subtitle">Add fields to create your custom form</p>
        </div>

        <form id="formBuilder" method="post" hx-post="#" hx-swap="none">
            {% csrf_token %}
            <div class="form-section">
                <div class="form-group">
                    <label for="form_name">Form Name</label>
                    <input type="text" id="form_name" name="form_name" class="form-control" required>
                </div>
            </div>

            <div class="form-section">
                <h3 class="section-title">Form Fields</h3>
                <div id="formFields">
                    <!-- Dynamic fields will be added here -->
                </div>
                
                <div class="field-template" style="display: none;">
                    <div class="field-row" data-field-id="__id__">
                        <div class="form-group">
                            <label>Field Name</label>
                            <input type="text" name="fields[__id__][name]" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Field Type</label>
                            <select name="fields[__id__][type]" class="form-control" required>
                                <option value="varchar">Text</option>
                                <option value="integer">Number</option>
                                <option value="text">Long Text</option>
                                <option value="date">Date</option>
                                <option value="boolean">Yes/No</option>
                                <option value="decimal">Decimal</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Max Length</label>
                            <input type="number" name="fields[__id__][max_length]" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Required</label>
                            <input type="checkbox" name="fields[__id__][required]" value="true">
                        </div>
                        <button type="button" class="btn btn-danger remove-field" onclick="removeField(this)">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>

                <button type="button" class="btn btn-secondary" onclick="addField()">
                    <i class="bi bi-plus"></i> Add Field
                </button>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Create Form</button>
            </div>
        </form>
    </div>
</div>

<style>
.field-row {
    display: flex;
    gap: 1rem;
    align-items: flex-end;
    padding: 1rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 1rem;
}

.form-group {
    flex: 1;
}

.remove-field {
    height: 38px;
}
</style>

<script>
let fieldCounter = 0;

function addField() {
    const template = document.querySelector('.field-template').innerHTML;
    const newField = template.replace(/__id__/g, fieldCounter++);
    const fieldsContainer = document.getElementById('formFields');
    const div = document.createElement('div');
    div.innerHTML = newField;
    fieldsContainer.appendChild(div.firstElementChild);
}

function removeField(button) {
    button.closest('.field-row').remove();
}

// Add initial field
document.addEventListener('DOMContentLoaded', function() {
    addField();
});

// Handle form submission
document.getElementById('formBuilder').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    // Convert FormData to a more structured format
    const data = {
        form_name: formData.get('form_name'),
        fields: []
    };
    
    // Get all field rows
    const fieldRows = document.querySelectorAll('.field-row');
    fieldRows.forEach((row, index) => {
        data.fields.push({
            name: formData.get(`fields[${row.dataset.fieldId}][name]`),
            type: formData.get(`fields[${row.dataset.fieldId}][type]`),
            max_length: formData.get(`fields[${row.dataset.fieldId}][max_length]`),
            required: formData.get(`fields[${row.dataset.fieldId}][required]`) === 'true'
        });
    });

    // Send the data using fetch
    fetch(this.getAttribute('hx-post'), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = data.redirect_url;
        } else {
            alert(data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while creating the form');
    });
});
</script>
{% endblock %}


